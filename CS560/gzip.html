<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Google Maps API v3 Zip Code Map using FusionTables and InfoBox</title>
 	    <style>
  #map_canvas { width: 100%; height: 100%; }
	.googft-info-window {
		display: none;
	}
        </style>
 	  
<!--Load the AJAX API-->

<link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

<script src="js/bootstrap.min.js"></script>

<script type="text/javascript" src="http://www.google.com/jsapi"></script>         <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/src/infobox.js"></script>

<script type="text/javascript" src="http://geoxml3.googlecode.com/svn/branches/polys/geoxml3.js"></script>
        <script type="text/javascript">
  google.load('visualization', '1', {'packages':['corechart', 'table', 'geomap']});
var map;
var labels = [];
var layer;
var tableid =  1499916;

function initialize() {
console.log("initialize");
    geocoder = new google.maps.Geocoder();
  	map = new google.maps.Map(document.getElementById('map_canvas'), {
    center: new google.maps.LatLng(37.23032838760389, -118.65234375),
    zoom: 6,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  });
  
  layer = new google.maps.FusionTablesLayer(tableid);
  layer.setQuery("SELECT 'geometry' FROM " + tableid);
  layer.setMap(map);

  codeAddress();

  	google.maps.event.addListener(layer, "click", function(event) {
		var e = event;
		var lat = event.latLng.lat();
		var lng = event.latLng.lng();
		// populate yor box/field with lat, lng
		//alert("Lat=" + lat + "; Lng=" + lng);
		
		
		var marker = new google.maps.Marker({
		  position: new google.maps.LatLng(lat, lng),
		  map: map,
	  });
	  
	  var geocoder = new google.maps.Geocoder();
	  geocoder.geocode({ "latLng":  new google.maps.LatLng(lat, lng)}, function (results, status) {
		if(status == google.maps.GeocoderStatus.OK) {
			
			console.log(results[0].address_components[8].long_name);
			//64129
			//64132
			//64999
			//64129
			console.log(results[0]);
			zipcode = results[0].address_components[8].long_name;
			console.log("zip code " + zipcode);
				  	$.ajaxSetup({ crossDomain: true, scriptCharset: "utf-8" , contentType: "jsonp; charset=utf-8"});
		$.ajax({
		//	var options = {
				type : "GET",
		//        url : url,
				url : "http://134.193.136.127:8983/solr/collection1_shard1_replica1/select?wt=json&indent=true&hl=true&hl.fl=,features&json.wrf=loadData",data:{"q":'id:2014_' + zipcode},
		//		async : false, cache : false,
				contentType: "application/json",
				dataType : "jsonp",
				jsonp : "callback",			
				jsonpCallback : "loadData",
				success : function(data, textStatus, jqXHR) {
					
						var d = data.response.docs[0];
					  console.log(data.response.docs[0].TOTAL_APRIL_AVERAGE_s);
					  
					  console.log(e);
					  e.infoWindowHtml = "";
					  e.infoWindowHtml = "Test and works great";
					  
					  var contentString = "Expected Crime Rate in this Month is: " + data.response.docs[0].TOTAL_APRIL_AVERAGE_s * 100;
						var crimeinfowindow = new google.maps.InfoWindow({
							content: contentString
						});
						infowindow.close();
						marker.setMap(null);
						crimeinfowindow.close(map);
						crimeinfowindow.open(map, marker);
						
				},
				error : function(XMLHttpRequest, textStatus, errorThrown) {
					alert("request error");
			}
		});
		}
	  
	  });
	  
	//  var url = "http://134.193.136.127:8983/solr/collection1_shard1_replica1/select?q=id%3A+%222014_64011%22&wt=json";

	}); 

  google.maps.event.addListener(map, "bounds_changed", function() {
    displayZips();
  });
  
  google.maps.event.addListener(map, "zoom_changed", function() {
    if (map.getZoom() < 11) {
      for (var i=0; i<labels.length; i++) {
        labels[i].setMap(null);
      }
    }
  });
}

function codeAddress() {
	console.log("code address");
    var address = document.getElementById("address").value;
	geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);
        var marker = new google.maps.Marker({
            map: map, 
            position: results[0].geometry.location
        });
        if (results[0].geometry.viewport) 
          map.fitBounds(results[0].geometry.viewport);
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });	
  }
  
function loadData(data) 
{
	console.log("load data");
	//alert("Load Data"+data);
	$.each(data.response.docs,function(i,doc){
		//$("#results").empty();
		//$("#results").append(doc.i);
	}
);
 }
function displayZips() {
  //set the query using the current bounds
  var queryStr = "SELECT geometry, ZIP, latitude, longitude FROM "+ tableid + " WHERE ST_INTERSECTS(geometry, RECTANGLE(LATLNG"+map.getBounds().getSouthWest()+",LATLNG"+map.getBounds().getNorthEast()+"))";   
  var queryText = encodeURIComponent(queryStr);
  var query = new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq='  + queryText);
  // alert(queryStr);

  //set the callback function
  query.send(displayZipText);

}
 

var infowindow = new google.maps.InfoWindow();
		
function displayZipText(response) {
if (!response) {
  alert('no response');
  return;
}
if (response.isError()) {
  alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
  return;
}
  if (map.getZoom() < 11) return;
  FTresponse = response;
  //for more information on the response object, see the documentation
  //http://code.google.com/apis/visualization/documentation/reference.html#QueryResponse
  numRows = response.getDataTable().getNumberOfRows();
  numCols = response.getDataTable().getNumberOfColumns();
/*  var queryStr = "SELECT geometry, ZIP, latitude, longitude FROM "+ tableid + " WHERE ST_INTERSECTS(geometry, RECTANGLE(LATLNG"+map.getBounds().getSouthWest()+",LATLNG"+map.getBounds().getNorthEast()+"))";   
*/
  /*
     var kml =  FTresponse.getDataTable().getValue(0,0);
     // create a geoXml3 parser for the click handlers
     var geoXml = new geoXML3.parser({
                    map: map,
		    zoom: false
                });
     geoXml.parseKmlString("<Placemark>"+kml+"</Placemark>");
     geoXml.docs[0].gpolygons[0].setMap(null);
     map.fitBounds(geoXml.docs[0].gpolygons[0].bounds);
  */
  // alert(numRows);
  // var bounds = new google.maps.LatLngBounds();
  for(i = 0; i < numRows; i++) {
      var zip = response.getDataTable().getValue(i, 1);
      var zipStr = zip.toString()
      while (zipStr.length < 5) { zipStr = '0' + zipStr; }
      var point = new google.maps.LatLng(
          parseFloat(response.getDataTable().getValue(i, 2)),
          parseFloat(response.getDataTable().getValue(i, 3)));
      // bounds.extend(point);
	  labels.push(new InfoBox({
	 content: zipStr
	,boxStyle: {
	   border: "1px solid black"
	  ,textAlign: "center"
	  ,fontSize: "8pt"
	  ,width: "50px"
	 }
	,disableAutoPan: true
	,pixelOffset: new google.maps.Size(-25, 0)
	,position: point
	,closeBoxURL: ""
	,isHidden: false
	,enableEventPropagation: true
      }));
      labels[labels.length-1].open(map);
  }
  // zoom to the bounds
  // map.fitBounds(bounds);
}

</script>
<body onload="initialize();">
<form> 
	<span class="style51"><span class="style49">Show</span>:</span> 
	<input id="address" type="text" value="64117"></input>
	<input id="geocode" type="button" onclick="codeAddress();" value="Geocode"></input>	  
	<div id="map_canvas"></div>
</body>
</html>
